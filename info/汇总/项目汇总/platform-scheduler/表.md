-- 任务定义表
CREATE TABLE schedule_task_definition (
id VARCHAR(50) PRIMARY KEY,
name VARCHAR(100) NOT NULL COMMENT '任务名称',
description TEXT COMMENT '任务描述',
task_type VARCHAR(50) NOT NULL COMMENT '任务类型:CRON/HTTP/CUSTOM',
task_config JSON COMMENT '任务配置(JSON格式)',
priority INT DEFAULT 0 COMMENT '优先级:0-10',
status VARCHAR(20) DEFAULT 'CREATED' COMMENT '任务状态',
retry_policy JSON COMMENT '重试策略',
create_time DATETIME NOT NULL,
update_time DATETIME NOT NULL,
KEY idx_task_type (task_type),
KEY idx_status (status),
KEY idx_priority (priority)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='任务定义表';

-- 任务执行表
CREATE TABLE schedule_task_execution (
id VARCHAR(50) PRIMARY KEY,
task_def_id VARCHAR(50) NOT NULL COMMENT '任务定义ID',
execution_node VARCHAR(100) COMMENT '执行节点',
start_time DATETIME COMMENT '开始时间',
end_time DATETIME COMMENT '结束时间',
status VARCHAR(20) DEFAULT 'WAITING' COMMENT '执行状态',
result TEXT COMMENT '执行结果',
error_message TEXT COMMENT '错误信息',
retry_count INT DEFAULT 0 COMMENT '重试次数',
create_time DATETIME NOT NULL,
update_time DATETIME NOT NULL,
KEY idx_task_def_id (task_def_id),
KEY idx_status (status),
KEY idx_start_time (start_time)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='任务执行表';

-- 任务变量表
CREATE TABLE schedule_task_variable (
id VARCHAR(50) PRIMARY KEY,
var_key VARCHAR(100) NOT NULL COMMENT '变量键',
var_value TEXT COMMENT '变量值',
description VARCHAR(500) COMMENT '描述',
scope VARCHAR(50) NOT NULL COMMENT '作用域:GLOBAL/TASK',
task_def_id VARCHAR(50) COMMENT '任务定义ID',
create_time DATETIME NOT NULL,
update_time DATETIME NOT NULL,
UNIQUE KEY uk_key_scope (var_key, scope, task_def_id),
KEY idx_task_def_id (task_def_id)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='任务变量表';

-- 任务锁表
CREATE TABLE schedule_task_lock (
id VARCHAR(50) PRIMARY KEY,
task_def_id VARCHAR(50) NOT NULL COMMENT '任务定义ID',
node_id VARCHAR(100) NOT NULL COMMENT '节点ID',
lock_time DATETIME NOT NULL COMMENT '加锁时间',
timeout INT NOT NULL COMMENT '超时时间(秒)',
create_time DATETIME NOT NULL,
UNIQUE KEY uk_task_def_id (task_def_id),
KEY idx_lock_time (lock_time)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='任务锁表';

-- 任务监控表
CREATE TABLE schedule_task_metrics (
id VARCHAR(50) PRIMARY KEY,
task_def_id VARCHAR(50) NOT NULL COMMENT '任务定义ID',
metric_name VARCHAR(100) NOT NULL COMMENT '指标名称',
metric_value DECIMAL(20,4) COMMENT '指标值',
collect_time DATETIME NOT NULL COMMENT '采集时间',
create_time DATETIME NOT NULL,
KEY idx_task_def_id (task_def_id),
KEY idx_metric_name (metric_name),
KEY idx_collect_time (collect_time)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='任务监控指标表';